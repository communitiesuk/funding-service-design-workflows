Parameters:
  App:
    Type: String
    Description: Your application's name.
  Env:
    Type: String
    Description: The environment name your service, job, or workflow is being deployed to.
Resources:
  CloudFrontFunction:
    Type: AWS::CloudFront::Function
    Properties:
      Name: EnforceBasicAuth
      FunctionConfig:
        Comment: A CloudFront function to enforce basic auth
        Runtime: cloudfront-js-2.0
      FunctionCode: 
        !Sub |
          function handler(event) {
              const username = '{{resolve:ssm-secure:/copilot/${App}/${Env}/secrets/BASIC_AUTH_USERNAME}}'
              // NOTE: This example function is for a viewer request event trigger.
              // Choose viewer request for the event trigger when you associate this function with a distribution.
              var response = {
                  statusCode: 200,
                  statusDescription: 'OK',
                  headers: {
                      'cloudfront-functions': { value: 'generated-by-CloudFront-Functions' }
                  }
              };
              return response;
          }
      AutoPublish: false